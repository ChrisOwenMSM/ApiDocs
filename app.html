
<!DOCTYPE html>
<html lang="en" ng-app="sampleApp">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Theme Template for Bootstrap</title>

    <!-- Bootstrap core CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap theme -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>

    <![endif]-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.16/angular.min.js"></script>
</head>

<body role="document">

<!-- Fixed navbar -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">MSM Partner API</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="#introduction">Introduction</a></li>
                <li><a href="#security">Security</a></li>
                <li><a href="#restrictions">Restrictions</a></li>
                <li><a href="#environments">Environments</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Using The API <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="#requests">Requests</a></li>
                        <li><a href="#response">Response</a></li>
                        <li><a href="#">Reference Data</a></li>
                        <li><a href="#">Schemas</a></li>
                    </ul>
                </li>
            </ul>
        </div><!--/.nav-collapse -->
    </div>
</nav>

<div class="container theme-showcase" role="main"  ng-controller="SampleAppController">

<!-- Main jumbotron for a primary marketing message or call to action -->

<a id="introduction"></a>
<div class="panel panel-primary" style="margin-top:80px">
    <div class="panel-heading">
        <h3 class="panel-title">Sample App</h3>
    </div>
    <div class="panel-body">
        <p>The MSM partner API allows to access the insurance applications that power the moneysupermarket.com website.</p>
        <p>It is designed to aid automated and exploratory testing of our partner mappings, without the need to use the website.</p>
        <p>The API allows you to submit requests to our home and car insurance products and validate the results that would appear on our website.</p>
    </div>

</div>


    <div class="row">
        <div class="col-sm-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Enquiry</h3>
                </div>
                <div class="panel-body">
                    <button type="button" class="btn btn-success" data-ng-click="submitForm()">Submit</button>
                    <textarea cols="40" rows="30" style="margin-top: 10px" data-ng-model="enquiry">


                    </textarea>
                </div>
            </div>

        </div><!-- /.col-sm-4 -->
        <div class="col-sm-8">
            <div class="panel panel-success">
                <div class="panel-heading">
                    <h3 class="panel-title">Results - Complete {{results.providers.complete.length}} - Remaining {{results.providers.inProgress.length}}</h3>
                </div>
                <div class="panel-body">
                    <table>
                        <tr data-ng-repeat="result in results.results">
                            <td><img data-ng-src="result.brandLogo"/> </td>
                            <td>{{results.brandName}} </td>
                            <td>{{results.quote.annualPrice}}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>


    </div>



</div> <!-- /container -->



<script>
    angular.module('sampleApp', [])
            .controller('SampleAppController', ['$scope', '$http', function($scope, $http, $timeout){


                $scope.results = {};
                $scope.results.providers = {};
                $scope.results.providers.complete = [];
                $scope.results.providers.inProgress = [];

                $scope.submitForm = function() {

                    $http.post('/gb/partners/aggregation/v1/home-insurance/enquiries?apikey='+$.QueryString["apikey"], $scope.enquiry).
                            success(function(data, status, headers, config) {
                                if(data.success == true) {
                                    $scope.enquiryId = data.enquiryId;
                                    $scope.resultsUrl = data.url;
                                    $timeout( function(){ $scope.getResults(url); }, 5000)
                                }
                            }).
                            error(function(data, status, headers, config) {
                                // called asynchronously if an error occurs
                                // or server returns response with an error status.
                                alert(status);
                            });
                };


                $scope.getResults = function(url) {
                    $http.get(url).
                            success(function(data, status, headers, config) {
                                $scope.results = data;
                                if(data.providers.complete.length > 0) {
                                    $timeout( function(){ $scope.getResults(url); }, 5000)
                                }
                            }).
                            error(function(data, status, headers, config) {
                                alert(status);
                            });
                }


                $scope.enquiry = JSON.stringify({
                    "payload": {
                        "property": {
                            "propertyTypeId": 1,
                            "propertySubTypeId": 1,
                            "address": {
                                "buildingNumber": "1",
                                "thoroughfare": "Victor Street",
                                "town": "CHESTER LE STREET",
                                "county": "County Durham",
                                "postcode": "DH3 3DP",
                                "countryCode": "GB"
                            },
                            "yearBuilt": 1970,
                            "rooms": {
                                "bedrooms": 3,
                                "bathrooms": 1,
                                "kitchens": 1,
                                "lounges": 1,
                                "otherRooms": 1
                            },
                            "areTreesCloseBy": false,
                            "percentageFlatRoofId": 1,
                            "ownershipTypeId": 6,
                            "purchasedDate": "2002-12-10",
                            "isPurchased": true,
                            "yearsLivedInProperty": 4,
                            "occupantTypeId": 1,
                            "numOfAdults": 2,
                            "numOfChildren": 0,
                            "dailyOccupationPeriodId": 1,
                            "maximumUnoccupiedPeriodId": 1,
                            "hasSmokers": false,
                            "businessUsagesId": 1,
                            "roofConstructionTypeId": 1,
                            "wallConstructionTypeId": 1,
                            "hasSufferedFromGroundMovement": false,
                            "hasBeenAffectedFromFlooding": false,
                            "protectedStatusId": 1,
                            "occupancyStatusId": 1,
                            "isForSale": false,
                            "isUnderPinned": false,
                            "buildingFloorTypeId": 1,
                            "hasCrackedWalls": false,
                            "isUndergoingBuildingWork": false,
                            "isOver400mFromWater": true,
                            "estimatedRebuildCost": 200000,
                            "minimumRebuildCost": 150000,
                            "maximumRebuildCost": 150000,
                            "wasRebuildCalculatorUsed": true
                        },
                        "policy": {
                            "isJointPolicy": true,
                            "policyStartDate": "2015-06-22",
                            "policyTypeId": 1,
                            "paymentTypeId": 1,
                            "buildingsExcess": 250,
                            "contentsExcess": 250,
                            "buildingsCover": {
                                "propertyValue": 260000,
                                "rebuildCost": 200000,
                                "includesAccidentalDamage": true,
                                "noClaimsYears": 5
                            },
                            "contentsCover": {
                                "totalReplacementValue": 20000,
                                "possessions": [
                                    {
                                        "possessionTypeId": 1,
                                        "description": "Antique Item Possesion",
                                        "replacementCost": 5000,
                                        "coverOutsideHome": false
                                    }
                                ],
                                "includesAccidentalDamage": true,
                                "otherPossessionsValue": 5000,
                                "noClaimsYears": 5
                            }
                        },
                        "claims": [

                        ],
                        "security": {
                            "neighbourhoodWatchStatusId": 1,
                            "doorLockTypeId": 2,
                            "patioDoorsLockTypeId": 1,
                            "otherDoorsLockTypeId": 1,
                            "hasWindowLocks": true,
                            "smokeAlarmCount": 3,
                            "hasSafe": true,
                            "alarm": {
                                "hasAlarm": true,
                                "isAlarmMaintained": true,
                                "isAlarmMonitored": true
                            }
                        },
                        "policyHolder": {
                            "name": "joe",
                            "surname": "smith",
                            "genderId": 1,
                            "dateOfBirth": "1978-12-04",
                            "maritalStatusId": 2,
                            "mainOccupation": {
                                "businessSectorId": 2,
                                "occupationId": 9,
                                "employmentStatus": 3
                            },
                            "ukResidentSinceBirth": true,
                            "telephone": "01111111111"
                        },
                        "jointPolicyHolder": {
                            "name": "joanne",
                            "surname": "smith",
                            "genderId": 2,
                            "dateOfBirth": "1978-12-04",
                            "maritalStatusId": 2,
                            "relationshipWithPolicyHolderId": 14,
                            "mainOccupation": {
                                "businessSectorId": 8,
                                "occupationId": 27,
                                "employmentStatus": 3
                            },
                            "ukResidentSinceBirth": true}}});

            }]);

    (function($) {
        $.QueryString = (function(a) {
            if (a == "") return {};
            var b = {};
            for (var i = 0; i < a.length; ++i)
            {
                var p=a[i].split('=');
                if (p.length != 2) continue;
                b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
            }
            return b;
        })(window.location.search.substr(1).split('&'))
    })(jQuery);
</script>

</body>
</html>
